#Imports
import matplotlib.pyplot as plt
import numpy as np
from nilearn import datasets, plotting, image
from nilearn.maskers import NiftiMapsMasker, NiftiLabelsMasker
from sklearn.decomposition import FastICA
import os


melodic_sum_file = os.path.abspath('../../Data/HCP/melodic_IC_sum.nii.gz') # Nifti 4D Data

labels = list(range(100)) # Labels 0-99

def get_hcp_maps_masker():
    
    masker = NiftiMapsMasker(
    maps_img=melodic_sum_file,
        smoothing_fwhm=6,  # gaussian kernel width (in mm)
        standardize="zscore_sample",  # zero mean, unit variance
        standardize_confounds="zscore_sample",
    )
    
    return masker

def get_hcp_labels_masker():
    masker = NiftiLabelsMasker(labels_img=melodic_sum_file, 
        smoothing_fwhm=6,  # gaussian kernel width (in mm)
        standardize="zscore_sample",  # zero mean, unit variance
        standardize_confounds="zscore_sample",)
    return masker

def get_atlas():
    # Load Image
    melodic_img = image.load_img(melodic_sum_file)
    return melodic_img

def get_region_coords(atlas, labels = range(100), threshold = 100):

    voxel_coords = plotting.find_probabilistic_atlas_cut_coords(atlas)
    #world_coords = [image.coord_transform(*i, atlas.affine) for i in voxel_coords]
    
    return voxel_coords
        
    
def get_component_regions(component_vector, threshold = 0.21):
    '''Gets the regions of the PCA/ICA network given the component cutoff value (Around 0.2)
    With the pca regions, we can visualize the network region generated by that component.

    Args:
        component_vector (list)  -- eigen vector of the pca component
        
    Keyword Args:
        threshold (float)        -- the cutoff that determines if the region is part of the network
    
    Returns:
    (set) each region in the pca component
    '''
    dic = dict(zip(labels, component_vector))
    
    return set([i for i in dic if abs(dic[i]) > threshold])

def get_component_masker(component_vector, threshold = 0.21):
    '''Gets the masker of the component vector given the component cutoff value (Around 0.2).
    With the masker, we can visualize the pca component region scores in the network.

    Args:
        component_vector (list)  -- eigen vector of the pca component
        
    Keyword Args:
        threshold (float)        -- the cutoff that determines if the region is part of the network
    
    Returns:
        masker of each pca component
    '''
    
    masker = np.copy(component_vector)
    
    # Assigns component score to masker if above threshold, else assign 0
    vals = np.abs(component_vector) < threshold
    masker[vals] = 0
        
    return masker

def plot_component(component_vector, masker, atlas, mean_img = None, title = "", style = "region", 
             display_mode = "ortho", cut_coords = None, threshold = 0.21):
    '''Plots the PCA/ICA component vector given the component cutoff value (Around 0.2) with the given style.

    Args:
        component_vector (list)  -- eigen vector of the pca component
        
    Keyword Args:
        title (str)              -- title of plot
        style (str)              -- style of the plot: "region" by regions, "score" by regions with score
        display_mode (str)       -- display_mode of the plot
        cut_coords (float)       -- the cut coords of the plot
        threshold (float)        -- the cutoff that determines if the region is part of the network
    
    Returns:
        plots the pca component
    '''

    fig, axs = plt.subplots(1, 1, figsize = (18, 10))

    if style == "region":
        
        # Get Regions of the component
        regions = get_component_regions(component_vector, threshold)

        # Builds the altas of the different regions
        atlas_regions = image.concat_imgs([image.index_img(atlas, labels.index(i)) for i in regions])

        # Visualizes the regions of the component
        plotting.plot_prob_atlas(
            atlas_regions, draw_cross = False, title = title, axes=axs, 
            display_mode = display_mode, cut_coords = cut_coords
        )
    
    if style == "score":
        # Create Masker Images
        component_img = masker.inverse_transform(get_component_masker(component_vector, threshold))
        
        # Plotting PCA component with scores
        plotting.plot_stat_map(component_img, mean_img, 
                               title = title, axes=axs, display_mode = display_mode, cut_coords = cut_coords
                              )

        